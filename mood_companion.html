<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mood Companion - MoodTunes</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container">
        <!-- Navigation -->
        <nav class="navbar">
            <div class="nav-container">
                <div class="logo">
                    <i class="fas fa-music"></i>
                    <span>EmoTune</span>
                </div>
                <div class="nav-links">
                    <a href="/" class="nav-link">Home</a>
                    <a href="/detection" class="nav-link">Detect Emotion</a>
                    <a href="#" class="nav-link active">Mood Companion</a>
                    <a href="/music_player" class="nav-link">Music Player</a>
                </div>
            </div>
        </nav>

        <!-- Mood Companion Section -->
        <section class="mood-companion-section">
            <div class="section-header">
                <h1>Mood Companion</h1>
                <p>Chat with our AI companion and keep a personal journal</p>
            </div>

            <!-- Main Content Area -->
            <div class="companion-content">
                <!-- Left Panel - Chat Section -->
                <div class="chat-panel">
                    <div class="panel-header">
                        <div class="panel-title">
                            <i class="fas fa-robot"></i>
                            <span>MoodBot</span>
                        </div>
                        <div class="current-mood" id="currentMoodDisplay">
                            <span class="mood-label">Current Mood:</span>
                            <span class="mood-value" id="moodValue">neutral</span>
                        </div>
                    </div>
                    
                    <div class="chat-container" id="chatContainer">
                        <div class="chat-messages" id="chatMessages">
                            <div class="bot-message">
                                <div class="message-avatar">
                                    <i class="fas fa-robot"></i>
                                </div>
                                <div class="message-content">
                                    <p>Hello! I'm MoodBot, your emotional well-being companion. How are you feeling today?</p>
                                    <span class="message-time">Just now</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="chat-input-area">
                            <div class="input-container">
                                <input type="text" id="chatInput" placeholder="Type your message..." maxlength="500">
                                <button id="sendBtn" class="send-btn" onclick="sendMessage()">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                            <div class="input-actions">
                                <button class="btn-small btn-secondary" onclick="clearChat()">
                                    <i class="fas fa-trash"></i> Clear Chat
                                </button>
                                <!-- <button class="btn-small btn-primary" onclick="refreshMood()">
                                    <i class="fas fa-sync-alt"></i> Update Mood
                                </button> -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Panel - Journal Section -->
                <div class="journal-panel">
                    <div class="panel-header">
                        <div class="panel-title">
                            <i class="fas fa-book"></i>
                            <span>Personal Journal</span>
                        </div>
                        <div class="journal-actions">
                            <button class="btn-small btn-primary" onclick="toggleJournalEntry()">
                                <i class="fas fa-plus"></i> New Entry
                            </button>
                            <button class="btn-small btn-secondary" onclick="loadJournalEntries()">
                                <i class="fas fa-refresh"></i> Refresh
                            </button>
                        </div>
                    </div>

                    <!-- New Entry Form -->
                    <div class="journal-entry-form" id="journalEntryForm" style="display: none;">
                        <div class="form-header">
                            <h3>New Journal Entry</h3>
                            <button class="close-btn" onclick="toggleJournalEntry()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="form-content">
                            <textarea id="journalTextArea" placeholder="Write about your thoughts, feelings, or experiences..." rows="6" maxlength="2000"></textarea>
                            <div class="form-actions">
                                <div class="character-count">
                                    <span id="charCount">0</span>/2000 characters
                                </div>
                                <div class="action-buttons">
                                    <button class="btn btn-secondary" onclick="toggleJournalEntry()">Cancel</button>
                                    <button class="btn btn-primary" onclick="saveJournalEntry()">
                                        <i class="fas fa-save"></i> Save Entry
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Search Bar -->
                    <div class="journal-search">
                        <div class="search-container">
                            <input type="text" id="journalSearchInput" placeholder="Search journal entries...">
                            <button class="search-btn" onclick="searchJournal()">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Journal Entries List -->
                    <div class="journal-entries" id="journalEntries">
                        <div class="empty-state">
                            <i class="fas fa-book-open"></i>
                            <p>No journal entries yet</p>
                            <small>Start writing to track your thoughts and moods</small>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Loading Overlay -->
        <div class="loading-overlay" id="loadingOverlay" style="display: none;">
            <div class="loading-content">
                <div class="loading-spinner">
                    <i class="fas fa-spinner fa-spin"></i>
                </div>
                <p>Processing...</p>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script>
        let currentEmotion = 'neutral';
        let isTyping = false;

        // Initialize the mood companion page
        document.addEventListener('DOMContentLoaded', function() {
            refreshMood();
            loadJournalEntries();
            
            // Character counter for journal
            const textarea = document.getElementById('journalTextArea');
            const charCount = document.getElementById('charCount');
            if (textarea && charCount) {
                textarea.addEventListener('input', function() {
                    charCount.textContent = this.value.length;
                });
            }

            // Enter key to send message
            const chatInput = document.getElementById('chatInput');
            if (chatInput) {
                chatInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
            }

            // Enter key to search journal
            const searchInput = document.getElementById('journalSearchInput');
            if (searchInput) {
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        searchJournal();
                    }
                });
            }
        });

        // Utility function to show notifications
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.style.cssText = `
                position: fixed;
                top: 100px;
                right: 20px;
                z-index: 10000;
                max-width: 400px;
                background: white;
                padding: 1rem 1.5rem;
                border-radius: 10px;
                box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
                border-left: 4px solid ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : type === 'warning' ? '#ff9800' : '#667eea'};
                animation: slideInRight 0.3s ease-out;
            `;
            
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-times-circle' : type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle'}"></i>
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; color: #999; cursor: pointer; margin-left: auto;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        // Refresh current mood from detection
        function refreshMood() {
            fetch('/get_current_emotion')
                .then(response => response.json())
                .then(data => {
                    currentEmotion = data.emotion || 'neutral';
                    document.getElementById('moodValue').textContent = currentEmotion;
                    
                    // Update mood display color
                    const moodValue = document.getElementById('moodValue');
                    moodValue.className = `mood-value emotion-${currentEmotion}`;
                })
                .catch(error => {
                    console.error('Error refreshing mood:', error);
                });
        }

        // Send chat message
        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message || isTyping) return;
            
            // Add user message to chat
            addMessageToChat(message, 'user');
            input.value = '';
            
            // Show typing indicator
            showTypingIndicator();
            isTyping = true;
            
            // Send to chatbot API
            fetch('/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: message,
                    emotion: currentEmotion
                })
            })
            .then(response => response.json())
            .then(data => {
                hideTypingIndicator();
                isTyping = false;
                
                if (data.reply) {
                    addMessageToChat(data.reply, 'bot');
                } else {
                    addMessageToChat('Sorry, I had trouble understanding that. Could you try rephrasing?', 'bot');
                }
            })
            .catch(error => {
                hideTypingIndicator();
                isTyping = false;
                console.error('Chat error:', error);
                addMessageToChat('I apologize, but I\'m having technical difficulties right now. Please try again in a moment.', 'bot');
            });
        }

        // Add message to chat display
        function addMessageToChat(message, sender) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `${sender}-message`;
            
            const now = new Date();
            const timeString = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            messageDiv.innerHTML = `
                <div class="message-avatar">
                    <i class="fas fa-${sender === 'user' ? 'user' : 'robot'}"></i>
                </div>
                <div class="message-content">
                    <p>${message}</p>
                    <span class="message-time">${timeString}</span>
                </div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Show typing indicator
        function showTypingIndicator() {
            const chatMessages = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typingIndicator';
            typingDiv.className = 'bot-message typing-indicator';
            typingDiv.innerHTML = `
                <div class="message-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="message-content">
                    <div class="typing-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            `;
            
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Hide typing indicator
        function hideTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) {
                indicator.remove();
            }
        }

        // Clear chat messages
        function clearChat() {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = `
                <div class="bot-message">
                    <div class="message-avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="message-content">
                        <p>Hello! I'm MoodBot, your emotional well-being companion. How are you feeling today?</p>
                        <span class="message-time">Just now</span>
                    </div>
                </div>
            `;
        }

        // Toggle journal entry form
        function toggleJournalEntry() {
            const form = document.getElementById('journalEntryForm');
            const textarea = document.getElementById('journalTextArea');
            const charCount = document.getElementById('charCount');
            
            if (form.style.display === 'none' || form.style.display === '') {
                form.style.display = 'block';
                textarea.value = '';
                charCount.textContent = '0';
                textarea.focus();
            } else {
                form.style.display = 'none';
            }
        }

        // Save journal entry
        function saveJournalEntry() {
            const textarea = document.getElementById('journalTextArea');
            const entry = textarea.value.trim();
            
            if (!entry) {
                showNotification('Please write something before saving.', 'warning');
                return;
            }
            
            fetch('/save_journal', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    entry: entry,
                    emotion: currentEmotion
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Journal entry saved successfully!', 'success');
                    toggleJournalEntry();
                    loadJournalEntries();
                } else {
                    showNotification('Failed to save journal entry.', 'error');
                }
            })
            .catch(error => {
                console.error('Save journal error:', error);
                showNotification('Error saving journal entry.', 'error');
            });
        }

        // Load journal entries
        function loadJournalEntries() {
            fetch('/get_journal_entries')
                .then(response => response.json())
                .then(data => {
                    displayJournalEntries(data.entries || []);
                })
                .catch(error => {
                    console.error('Load journal error:', error);
                    showNotification('Error loading journal entries.', 'error');
                });
        }

        // Display journal entries with improved scrolling
        function displayJournalEntries(entries) {
            const container = document.getElementById('journalEntries');
            
            if (!entries || entries.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-book-open"></i>
                        <p>No journal entries yet</p>
                        <small>Start writing to track your thoughts and moods</small>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            
            // Create scrollable container
            const scrollableContainer = document.createElement('div');
            scrollableContainer.style.cssText = `
                max-height: calc(100% - 20px);
                overflow-y: auto;
                padding-right: 10px;
                margin-right: -10px;
            `;
            
            entries.forEach((entry, index) => {
                const entryDiv = document.createElement('div');
                entryDiv.className = 'journal-entry';
                entryDiv.style.marginBottom = '1rem';
                
                // Handle date parsing more robustly
                let displayDate = 'Unknown date';
                let displayTime = '';
                
                try {
                    if (entry.date) {
                        const dateObj = new Date(entry.date);
                        if (!isNaN(dateObj.getTime())) {
                            displayDate = dateObj.toLocaleDateString();
                            displayTime = dateObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                        }
                    }
                } catch (e) {
                    console.warn('Date parsing error:', e);
                }
                
                entryDiv.innerHTML = `
                    <div class="entry-header" style="display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.25rem; background: #f8f9fa; border-bottom: 1px solid #e0e6ed;">
                        <div class="entry-mood emotion-${entry.emotion}" style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; font-weight: 600; text-transform: capitalize;">
                            <i class="fas fa-circle" style="font-size: 0.75rem;"></i>
                            <span>${entry.emotion || 'neutral'}</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div class="entry-date" style="font-size: 0.8rem; color: #6c757d;">
                                ${displayDate}${displayTime ? ` at ${displayTime}` : ''}
                            </div>
                            <button class="delete-entry" onclick="deleteJournalEntry('${entry.id}', ${index})" 
                                    style="background: none; border: none; color: #6c757d; cursor: pointer; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease;"
                                    onmouseover="this.style.backgroundColor='#f44336'; this.style.color='white'; this.style.transform='scale(1.1)';"
                                    onmouseout="this.style.backgroundColor='transparent'; this.style.color='#6c757d'; this.style.transform='scale(1)';">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="entry-content" style="padding: 1.25rem; max-height: 200px; overflow-y: auto;">
                        <p style="margin: 0; line-height: 1.6; color: #495057; white-space: pre-wrap; word-wrap: break-word;">${entry.text}</p>
                    </div>
                `;
                
                scrollableContainer.appendChild(entryDiv);
            });
            
            container.appendChild(scrollableContainer);
        }

        // Delete journal entry with better error handling
        function deleteJournalEntry(entryId, index) {
            if (!entryId) {
                showNotification('Cannot delete entry: Invalid ID', 'error');
                return;
            }
            
            if (!confirm('Are you sure you want to delete this journal entry?')) {
                return;
            }
            
            // Show loading state
            const deleteButton = event.target.closest('.delete-entry');
            if (deleteButton) {
                deleteButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                deleteButton.disabled = true;
            }
            
            fetch(`/delete_journal/${entryId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Journal entry deleted.', 'success');
                    loadJournalEntries(); // Reload entries
                } else {
                    showNotification(data.error || 'Failed to delete journal entry.', 'error');
                    // Restore button state
                    if (deleteButton) {
                        deleteButton.innerHTML = '<i class="fas fa-trash"></i>';
                        deleteButton.disabled = false;
                    }
                }
            })
            .catch(error => {
                console.error('Delete journal error:', error);
                showNotification('Error deleting journal entry. Please try again.', 'error');
                // Restore button state
                if (deleteButton) {
                    deleteButton.innerHTML = '<i class="fas fa-trash"></i>';
                    deleteButton.disabled = false;
                }
            });
        }

        // Search journal entries
        function searchJournal() {
            const query = document.getElementById('journalSearchInput').value.trim();
            
            if (!query) {
                loadJournalEntries();
                return;
            }
            
            fetch('/search_journal', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ query: query })
            })
            .then(response => response.json())
            .then(data => {
                displayJournalEntries(data.entries || []);
            })
            .catch(error => {
                console.error('Search journal error:', error);
                showNotification('Error searching journal entries.', 'error');
            });
        }

        // Add CSS for smooth scrolling
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInRight {
                from { transform: translateX(100%); }
                to { transform: translateX(0); }
            }
            
            .journal-entries::-webkit-scrollbar {
                width: 6px;
            }
            
            .journal-entries::-webkit-scrollbar-track {
                background: #f1f1f1;
                border-radius: 3px;
            }
            
            .journal-entries::-webkit-scrollbar-thumb {
                background: #667eea;
                border-radius: 3px;
            }
            
            .journal-entries::-webkit-scrollbar-thumb:hover {
                background: #764ba2;
            }
            
            .entry-content::-webkit-scrollbar {
                width: 4px;
            }
            
            .entry-content::-webkit-scrollbar-track {
                background: #f8f9fa;
                border-radius: 2px;
            }
            
            .entry-content::-webkit-scrollbar-thumb {
                background: #dee2e6;
                border-radius: 2px;
            }
            
            .entry-content::-webkit-scrollbar-thumb:hover {
                background: #adb5bd;
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>